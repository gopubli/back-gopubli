name: Deploy to GoPubli via SSH

on:
  push:
    branches:
      - main
  workflow_dispatch:  # Permite executar manualmente

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        
      - name: Setup PHP
        uses: shivammathur/setup-php@v2
        with:
          php-version: '8.3'
          extensions: mbstring, xml, ctype, iconv, intl, pdo_mysql, dom, filter, gd, json, zip
          coverage: none
          
      - name: Install Composer dependencies
        run: composer install --no-dev --optimize-autoloader --no-interaction --prefer-dist
        
      - name: Install Node dependencies and build assets
        run: |
          npm ci
          npm run build
        
      - name: Create deployment archive
        run: |
          tar -czf deploy.tar.gz \
            --exclude='.git' \
            --exclude='.github' \
            --exclude='node_modules' \
            --exclude='tests' \
            --exclude='.env' \
            --exclude='.env.example' \
            --exclude='storage/app/*' \
            --exclude='storage/framework/cache/data/*' \
            --exclude='storage/framework/sessions/*' \
            --exclude='storage/framework/testing/*' \
            --exclude='storage/framework/views/*' \
            --exclude='storage/logs/*' \
            --exclude='public/hot' \
            --exclude='*.md' \
            .

      - name: Create deployment script
        run: |
          cat > deploy-remote.sh << 'EOFDEPLOY'
          #!/bin/bash
          set -e
          
          # Configura√ß√µes
          DEPLOY_PATH="/home/gopublicom/api.gopubli.com.br"
          BACKUP_PATH="/home/gopublicom/backups"
          TIMESTAMP=$(date +%Y%m%d_%H%M%S)
          
          echo "üöÄ Iniciando deploy - $TIMESTAMP"
          
          # Criar diret√≥rios se n√£o existirem
          mkdir -p $BACKUP_PATH
          mkdir -p $DEPLOY_PATH/storage/{app/public,framework/{cache/data,sessions,views},logs}
          mkdir -p $DEPLOY_PATH/bootstrap/cache
          
          # Backup do .env atual (se existir)
          if [ -f "$DEPLOY_PATH/.env" ]; then
              echo "üìã Backup do .env..."
              cp $DEPLOY_PATH/.env $BACKUP_PATH/.env.$TIMESTAMP
          fi
          
          # Extrair novos arquivos
          echo "üì¶ Extraindo arquivos..."
          cd $DEPLOY_PATH
          tar -xzf ~/deploy_temp/deploy.tar.gz
          
          # Restaurar .env
          if [ -f "$BACKUP_PATH/.env.$TIMESTAMP" ]; then
              cp $BACKUP_PATH/.env.$TIMESTAMP $DEPLOY_PATH/.env
          fi
          
          # Ajustar permiss√µes
          echo "üîí Ajustando permiss√µes..."
          chmod -R 775 storage bootstrap/cache 2>/dev/null || true
          
          # Comandos Laravel
          echo "‚ö° Executando comandos Laravel..."
          
          # Verificar se precisa gerar key
          if ! grep -q "APP_KEY=base64:" .env 2>/dev/null; then
              echo "üîë Gerando APP_KEY..."
              php artisan key:generate --force
          fi
          
          # Cache e otimiza√ß√µes
          php artisan cache:clear
          php artisan config:clear
          php artisan route:clear
          php artisan view:clear
          
          # Migrations
          php artisan migrate --force
          
          # Storage link
          php artisan storage:link || true
          
          # Otimizar para produ√ß√£o
          php artisan config:cache
          php artisan route:cache
          php artisan view:cache
          
          # Limpar arquivos tempor√°rios
          rm -f ~/deploy_temp/deploy.tar.gz
          
          echo "‚úÖ Deploy conclu√≠do com sucesso!"
          EOFDEPLOY
          
          chmod +x deploy-remote.sh

      - name: Upload files to server
        uses: appleboy/scp-action@master
        with:
          host: ${{ secrets.SSH_HOST }}
          username: ${{ secrets.SSH_USERNAME }}
          password: ${{ secrets.SSH_PASSWORD }}
          port: ${{ secrets.SSH_PORT }}
          source: "deploy.tar.gz,deploy-remote.sh"
          target: "~/deploy_temp"

      - name: Execute deployment
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.SSH_HOST }}
          username: ${{ secrets.SSH_USERNAME }}
          password: ${{ secrets.SSH_PASSWORD }}
          port: ${{ secrets.SSH_PORT }}
          script: |
            cd ~/deploy_temp
            chmod +x deploy-remote.sh
            bash deploy-remote.sh
            rm -rf ~/deploy_temp
      
      - name: Notify deployment success
        if: success()
        run: echo "‚úÖ Deployment completed successfully!"

      - name: Notify deployment failure
        if: failure()
        run: echo "‚ùå Deployment failed!"
