name: Deploy to GoPubli via SSH

on:
  push:
    branches:
      - main
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up SSH
        uses: webfactory/ssh-agent@v0.8.0
        with:
          ssh-private-key: ${{ secrets.SSH_KEY }}

      - name: Sync files to server
        run: |
          rsync -avz --no-perms -e 'ssh -p 22022 -o StrictHostKeyChecking=no' \
            --exclude='.git*' \
            --exclude='.github' \
            --exclude='node_modules' \
            --exclude='vendor' \
            --exclude='composer.phar' \
            --exclude='.env' \
            --exclude='storage/app/public' \
            --exclude='storage' \
            --exclude='public/storage' \
            --exclude='tests' \
            --exclude='*.md' \
            --delete \
            ./ ${{ secrets.SSH_USERNAME }}@${{ secrets.SSH_HOST }}:/home/gopublicom/api.gopubli.com.br/
  
      - name: Run remote commands
        run: |
          ssh -p 22022 -o StrictHostKeyChecking=no ${{ secrets.SSH_USERNAME }}@${{ secrets.SSH_HOST }} << 'EOF'
          cd /home/gopublicom/api.gopubli.com.br

          # Corrigir permissões
          chown -R gopublicom:gopublicom .
          chmod 644 /home/gopublicom/api.gopubli.com.br/public/.htaccess || true
          chown gopublicom:gopublicom /home/gopublicom/api.gopubli.com.br/public/.htaccess || true
          chmod 755 /home/gopublicom/api.gopubli.com.br/public || true
          chmod 755 /home/gopublicom/api.gopubli.com.br || true

          # Permissões de storage e cache
          chown -R gopublicom:gopublicom /home/gopublicom/api.gopubli.com.br/storage /home/gopublicom/api.gopubli.com.br/bootstrap/cache /home/gopublicom/api.gopubli.com.br/public || true
          find /home/gopublicom/api.gopubli.com.br/storage -type d -exec chmod 755 {} \; || true
          find /home/gopublicom/api.gopubli.com.br/storage -type f -exec chmod 644 {} \; || true
          chmod -R 755 /home/gopublicom/api.gopubli.com.br/public/storage || true

          # Criar storage symlink
          if [ -L /home/gopublicom/api.gopubli.com.br/public/storage ]; then
            rm /home/gopublicom/api.gopubli.com.br/public/storage || true
            /opt/cpanel/ea-php83/root/bin/php /home/gopublicom/api.gopubli.com.br/artisan storage:link || php /home/gopublicom/api.gopubli.com.br/artisan storage:link || true
          elif [ -d /home/gopublicom/api.gopubli.com.br/public/storage ]; then
            echo "public/storage is a directory — skipping"
          else
            /opt/cpanel/ea-php83/root/bin/php /home/gopublicom/api.gopubli.com.br/artisan storage:link || php /home/gopublicom/api.gopubli.com.br/artisan storage:link || true
          fi

          # Variáveis de ambiente
          export PATH="/usr/bin/ea-php83:$PATH"
          export COMPOSER_ALLOW_SUPERUSER=1

          # Instalar dependências PHP
          /opt/cpanel/ea-php83/root/bin/php /opt/cpanel/composer/bin/composer install --no-interaction --prefer-dist --optimize-autoloader --no-dev

          # Frontend
          npm install
          npm run build

          # Comandos Laravel
          /opt/cpanel/ea-php83/root/bin/php artisan migrate --force
          /opt/cpanel/ea-php83/root/bin/php artisan config:cache
          /opt/cpanel/ea-php83/root/bin/php artisan route:cache
          /opt/cpanel/ea-php83/root/bin/php artisan view:cache
          /opt/cpanel/ea-php83/root/bin/php artisan cache:clear

          echo "✅ Deploy concluído com sucesso!"

          EOF
      
      - name: Notify deployment success
        if: success()
        run: echo "✅ Deployment completed successfully!"

      - name: Notify deployment failure
        if: failure()
        run: echo "❌ Deployment failed!"
