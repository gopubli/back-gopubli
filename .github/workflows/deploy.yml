name: Deploy to GoPubli via SSH

on:
  push:
    branches:
      - main
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup PHP
        uses: shivammathur/setup-php@v2
        with:
          php-version: '8.2'
          extensions: mbstring, xml, curl, zip
          tools: composer:v2

      - name: Set up SSH
        uses: webfactory/ssh-agent@v0.8.0
        with:
          ssh-private-key: ${{ secrets.SSH_PRIVATE_KEY }}

      - name: Install PHP dependencies locally
        run: |
          composer install --no-dev --optimize-autoloader --classmap-authoritative --no-interaction

      - name: Sync files to server
        run: |
          rsync -avz --no-perms -e 'ssh -p 65002 -o StrictHostKeyChecking=no' \
            --exclude='.git*' \
            --exclude='.github' \
            --exclude='node_modules' \
            --exclude='.env' \
            --exclude='storage/app/*' \
            --exclude='storage/framework/cache/data/*' \
            --exclude='storage/framework/sessions/*' \
            --exclude='storage/framework/views/*' \
            --exclude='storage/logs/*' \
            --exclude='tests' \
            --exclude='*.md' \
            --delete \
            ./ ${{ secrets.SSH_USERNAME }}@${{ secrets.SSH_HOST }}:/home/gopublicom/api.gopubli.com.br
  
      - name: Run deployment commands
        run: |
          ssh -p 65002 -o StrictHostKeyChecking=no ${{ secrets.SSH_USERNAME }}@${{ secrets.SSH_HOST }} << 'EOF'
          cd /home/gopublicom/api.gopubli.com.br

          # Garantir estrutura de diret√≥rios
          mkdir -p storage/{app/public,framework/{cache/data,sessions,views},logs}
          mkdir -p bootstrap/cache

          # Ajustar permiss√µes
          chmod -R 775 storage bootstrap/cache 2>/dev/null || true
          find storage -type d -exec chmod 755 {} \; 2>/dev/null || true
          find storage -type f -exec chmod 644 {} \; 2>/dev/null || true

          # Verificar se vendor existe (enviado pelo rsync)
          echo "üì¶ Verificando depend√™ncias..."
          if [ ! -d "vendor" ]; then
            echo "‚ùå Diret√≥rio vendor n√£o encontrado!"
            exit 1
          fi
          
          echo "‚úÖ Depend√™ncias j√° instaladas (vendor sincronizado)"

          # Verificar se .env existe
          if [ ! -f ".env" ]; then
            echo "‚ö†Ô∏è Aviso: Arquivo .env n√£o encontrado!"
            exit 1
          fi

          # Descobrir pacotes Laravel manualmente
          php artisan package:discover --ansi
          
          # Comandos Laravel
          echo "üîë Gerando Application Key..."
          php artisan key:generate --force --ansi || true
          
          echo "üóÑÔ∏è  Executando Migrations..."
          php artisan migrate --force --verbose --ansi
          
          echo "üîó Criando link do storage..."
          php artisan storage:link --ansi || true
          
          # Cache
          echo "‚ö° Otimizando cache..."
          php artisan config:cache --ansi
          php artisan route:cache --ansi
          php artisan view:cache --ansi

          echo "‚úÖ Deploy conclu√≠do!"
          EOF
      
      - name: Notify success
        if: success()
        run: echo "‚úÖ Deploy completed successfully!"

      - name: Notify failure
        if: failure()
        run: echo "‚ùå Deploy failed!"
